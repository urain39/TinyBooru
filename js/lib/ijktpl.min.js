var IJKTPL=function(){"use strict";var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},a={"&amp;":"&","&lt;":"<","&gt;":">","&#34;":'"',"&quot;":'"',"&#39;":"'","&apos;":"'"};function i(e,t){if(!e)throw new Error(t||"Assertion Failed!")}function r(e,t,n){i(this instanceof r),i("object"!=typeof elememt,"Need an object-like element!"),function(e,t,n,i){e._element=t,e._mapper=n,e._options=null,e._source=t.innerHTML;var r={prefix:"[[",suffix:"]]",debug:!(e._ast=[])};for(var s in i)r[s]=i[s];e._options=r,void 0===e._source&&("function"==typeof t.html?(e._element=t[0],e._source=t.html()):e._die("Invalid element object!"))}(this,e,t||{},n||{})}return r.prototype._die=function(n){return function(e,t){throw new SyntaxError(n)}()},r.prototype._precheck=function(e,t,n){!function(e,t,n,i){var r=0,s=0,o=0,u=!0;for(r=0;r<t.length;r++)u&&t.substr(r,n.length)===n?(o=r,u=!1,r+=n.length-1):u||t.substr(r,i.length)!==i?u||t.substr(r,n.length)!==n||e._die("No Closing Token["+s+"] at the '"+t.substring(o,r)+"'"):(u=!0,r+=i.length-1,s+=1);u||e._die("Missing '"+i+"' at the '"+t.substring(o,r)+"'")}(this,e,t,n)},r.prototype._valueOf=function(u,p){return function(e,t,n){var i,r,s,o;for(r=p,s=(o=u.split(".")).length-1,i=0;i<s;i++)"object"!=typeof r[o[i]]&&e._die("Subtoken parent '"+o[i]+"' is not an object!"),r=r[o[i]];return r[o[s]]}(this)},r.prototype.parse=function(e){return function(e,t,n){var i=[],r=n.prefix||"[[",s=n.suffix||"]]";e._precheck(t,r,s);var o,u,p,l,c,a,h,f,g,d,_=[],b=r+"@",k=s;for(o=0;o<t.length;o++)if(t.substr(o,r.length)!==r)_.push(t[o]);else{switch(u=o+r.length,-1===(p=t.indexOf(s,u))&&e._die("Missing '"+s+"'"),_.length&&(i.push({op:">",content:_.join("")}),_.length=0),l=(c=t.substring(u,p)).substr(0,1),p+=s.length,l){case"?":a=r+":"+(c=c.substr(1))+s,h=r+";"+c+s,-1===(u=t.indexOf(a,p))?(-1===(u=t.indexOf(h,p))&&e._die("Missing '"+h+"'"),g=null,(f=t.substring(p,u))&&(f=e.parse(f))):((f=t.substring(p,u))&&(f=e.parse(f)),p=u+a.length,-1===(u=t.indexOf(h,p))&&e._die("Missing '"+h+"'"),(g=t.substring(p,u))&&(g=e.parse(g))),(f||g)&&i.push({op:"?",id:c,thenBlock:f,elseBlock:g}),p=u+h.length;break;case"^":h=r+"$"+(c=c.substr(1))+s,-1===(u=t.indexOf(b,p))?e._die("Missing iteration binding with '"+b+"'"):(p=u+b.length,u=t.indexOf(k,p),d=t.substring(u,p),p=u+k.length,-1===(u=t.indexOf(h,p))&&e._die("Missing '"+h+"'"),f=t.substring(p,u)),f&&i.push({op:"^",id:c,bind:d,thenBlock:e.parse(f)}),p=u+h.length;break;default:i.push({op:"#",id:c})}o=p-1}return _.length&&i.push({op:">",content:_.join("")}),i}(this,e||this._source,this._options)},r.prototype._astRender=function(e,t,n){return function(e,t,n,i){var r,s,o,u,p,l;for(r=0;r<n.length;r++)switch(n[r].op){case"?":(p=e._valueOf(n[r].id,i))?n[r].thenBlock&&e._astRender(t,n[r].thenBlock,i):n[r].elseBlock&&e._astRender(t,n[r].elseBlock,i);break;case"^":if("object"==typeof(p=e._valueOf(n[r].id,i))&&"number"==typeof p.length){for(o in s={},i)s[o]=i[o];for(u=0;u<p.length;u++)s[n[r].bind]=p[u],n[r].thenBlock&&e._astRender(t,n[r].thenBlock,s)}else e._die("Token '"+n[r].id+"' is not iterble");break;case">":t.push(n[r].content.replace(/&amp;|&lt;|&gt;|&#34;|&quot;|&#39;|&apos;/g,function(e){return a[e]}));break;case"#":t.push("string"==typeof(l=e._valueOf(n[r].id,i))?l.replace(/[&<>"']/g,function(e){return c[e]}):l)}}(this,e,t,n)},r.prototype.render=function(e){return n=(t=this)._ast,i=e||{},r=[],t._astRender(r,n,i),t._element.innerHTML=r.join(""),r;var t,n,i,r},r.prototype.compile=function(){return(e=this)._ast=e.parse(e._source),e.render(e._mapper);var e},r.prototype.rebind=function(e,t,n){var i,r,s,o;i=this,r=e,s=t||this._mapper,o=n||this._options,i.constructor(r,s,o)},r}();"object"==typeof exports&&(exports.IJKTPL=IJKTPL);