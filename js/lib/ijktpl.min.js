var IJKTPL=function(){"use strict";var f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;","/":"&#47;","=":"&#61;","`":"&#96;"},a={"&amp;":"&","&lt;":"<","&gt;":">"};function s(e,t){if(!e)throw new Error(t||"Assertion Failed!")}function p(e,t,n){s(this instanceof p),s("object"!=typeof elememt,"Need an object-like element!");var o=this;t||(t={}),n||(n={}),o._element=e,o._mapper=t,o._options=null,o._source=e.innerHTML;var i,r={prefix:"[[",suffix:"]]",debug:!(o._ast=[])};for(i in n)r[i]=n[i];o._options=r,void 0===o._source&&("function"==typeof e.html?(o._element=e[0],o._source=e.html()):o._die("Invalid element object!"))}return"function"==typeof NodeList&&"function"!=typeof NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t){var n,o=this;for(n=0;n<o.length;n++)e.apply(t,[o[n],n,o])}),p.prototype._die=function(e){throw new SyntaxError(e)},p.prototype._valueOf=function(e,t){var n,o,i,r;for(o=t,i=(r=e.split(".")).length-1,n=0;n<i;n++)"object"!=typeof o[r[n]]&&this._die("Subtoken parent '"+r[n]+"' is not an object!"),o=o[r[n]];return o[r[i]]},p.prototype.parse=function(e){var t=this,n=[],o=t._options.prefix||"[[",i=t._options.suffix||"]]";e||(e=t._source);var r,s,p,l,c,f,a,u,h,d,_,g=[],b=o+"@",y=i;for(r=0;r<e.length;r++)if(e.substr(r,o.length)!==o)g.push(e[r]);else{switch(s=r+o.length,-1===(p=e.indexOf(i,s))&&t._die("Missing '"+i+"'"),g.length&&(n.push({op:">",content:g.join("")}),g.length=0),l=(f=e.slice(s,p)).substr(0,1),p+=i.length,l){case"?":a=o+":"+(f=f.substr(1))+i,u=o+";"+f+i,-1===(s=e.indexOf(u,p))&&t._die("Missing '"+u+"'"),h=(c=(c=e.slice(p,s)).split(a,2))[0],d=c[1],h&&(h=t.parse(h)),d&&(d=t.parse(d)),(h||d)&&n.push({op:"?",id:f,thenBlock:h,elseBlock:d}),p=s+u.length;break;case"^":u=o+"$"+(f=f.substr(1))+i,-1===(s=e.indexOf(u,p))&&t._die("Missing '"+u+"'"),c=s,(-1===(s=e.indexOf(b,p))||c<s)&&t._die("Missing binding begins with '"+b+"'"),p=s+b.length,(-1===(s=e.indexOf(y,p))||c<s)&&t._die("Missing binding ends with '"+y+"'"),_=e.slice(p,s),p=s+y.length,(h=e.slice(p,c))&&n.push({op:"^",id:f,bind:_,thenBlock:t.parse(h)}),p=c+u.length;break;default:n.push({op:"#",id:f})}r=p-1}return g.length&&n.push({op:">",content:g.join("")}),n},p.prototype._renderAST=function(e,t,n){var o,i,r,s,p,l,c=this;for(o=0;o<t.length;o++)switch(t[o].op){case"?":(p=c._valueOf(t[o].id,n))?t[o].thenBlock&&c._renderAST(e,t[o].thenBlock,n):t[o].elseBlock&&c._renderAST(e,t[o].elseBlock,n);break;case"^":if("object"==typeof(p=c._valueOf(t[o].id,n))&&"number"==typeof p.length){for(r in i={},n)i[r]=n[r];for(s=0;s<p.length;s++)i[t[o].bind]=p[s],t[o].thenBlock&&c._renderAST(e,t[o].thenBlock,i)}else c._die("Token '"+t[o].id+"' is not iterble");break;case">":e.push(t[o].content.replace(/&amp;|&lt;|&gt;/g,function(e){return a[e]}));break;case"#":e.push("string"==typeof(l=c._valueOf(t[o].id,n))?l.replace(/[&<>"'/`=]/g,function(e){return f[e]}):l)}},p.prototype.render=function(e){e||(e={});var t=[];return this._renderAST(t,this._ast,e),t=t.join(""),this._element.innerHTML=t},p.prototype.compile=function(){var e=this;return e._ast=e.parse(e._source),e.render(e._mapper)},p}();"object"==typeof exports&&(exports.IJKTPL=IJKTPL);