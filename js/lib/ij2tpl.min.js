(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).IJ2TPL={})})(this,function(e){"use strict";function u(e,r){var t;4===e[0]&&(t=e[1],n.test(t)&&(t=t.replace(i,"")),t?e[1]=t:r.pop())}var r,t,p={},d=((r={})["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r),v=/[\s\xA0\uFEFF]+/g,n=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,i=/[\t \xA0\uFEFF]+$/;function o(e,r,t){for(var n,i,o,a=[7,""],s=[],l=0,c=e.length,f=r.length,h=t.length;l<c;){if(!~(o=e.indexOf(r,l))){(i=e.slice(l))&&(a=[4,i],s.push(a));break}if(i=e.slice(l,o),o+=f,i&&(a=[4,i],s.push(a)),!~(l=e.indexOf(t,o)))throw new Error("No matching prefix '"+r+"'");if("-"!==e[o]){if(i=e.slice(o,l),l+=h,i=i.replace(v,""))switch(n=i[0]){case"?":case"!":case"*":case"/":case"@":if(u(a,s),l<c)switch(e[l]){case"\n":l+=1;break;case"\r":l+=(o=l+1)<c&&"\n"===e[o]?2:1}case"#":a=[d[n],i.slice(1)],s.push(a);break;default:a=[6,i],s.push(a)}}else u(a,s),l+=h}return s}function g(e){return String(e).replace(a,function(e){return s[e]})}var w={}.hasOwnProperty,a=/["&'\/<=>`]/g,s={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},l=g,b=(c.prototype.resolve=function(e){var r,t,n,i,o,a,s=null,l=this,c=!1;if(!e[3])if(t=l.cache,n=e[0],w.call(t,n))s=t[n];else{(o=e[1])?(i=o[0],c=!0):i=n;do{if((r=l.data)&&w.call(r,i)){if(s=r[i],c)for(var f=1,h=o.length;f<h;f++){if(i=o[f],!s||!w.call(s,i)){s=null;break}s=s[i]}break}l=l.parent}while(l);"function"==typeof s&&(s=s(l)),t[n]=s}if(a=e[2])for(var u,f=0,h=a.length;f<h;){if(u=a[f++],!w.call(p,u))throw new Error("Cannot resolve filter '"+u+"'");s=p[u](s)}return s},c);function c(e,r){this.data=e,this.cache={".":this.data},this.parent=r}var f,k=Array.isArray;k||(f={}.toString,k=function(e){return"[object Array]"===f.call(e)});var h=(x.prototype.renderTree=function(e,r,t){for(var n,i,o,a="",s=!1,l=0,c=e.length;l<c;)switch((o=e[l++])[0]){case 0:if(i=o,n=r.resolve(i[1]),(s=k(n))?n.length:n)if(s)for(var f=0,h=n.length,u=void 0;f<h;)u=n[f++],a+=this.renderTree(i[2],new b(u,r),t);else a+=this.renderTree(i[2],new b(n,r),t);break;case 1:i=o,n=r.resolve(i[1]),((s=k(n))?n.length:n)||(a+=this.renderTree(i[2],r,t));break;case 2:if(i=o,n=r.resolve(i[1]),(s=k(n))?n.length:n)if(s)for(var p=0,d=n.length,u=void 0;p<d;)u=n[p++],a+=this.renderTree(i[2],new b(u,r),t);else a+=this.renderTree(i[2],new b(n,r),t);else a+=this.renderTree(i[3],r,t);break;case 4:a+=n=o[1];break;case 5:null!=(n=r.resolve(o[1]))&&(a+=n);break;case 6:null!=(n=r.resolve(o[1]))&&(a+="number"==typeof n?n:g(n));break;case 8:if(n=o[1],!t||!w.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");a+=this.renderTree(t[n].treeRoot,r,t)}return a},x.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new b(e,null),r)},x);function x(e){this.treeRoot=e}function y(e){var r=null,t=null,n=!1,i=e[1];return~i.indexOf("|")&&(i=(t=i.split("|"))[0],t=t.slice(1),F[i]&&(n=!0)),0<i.indexOf(".")&&(r=i.split(".")),[e[0],[i,r,t,n]]}var T=((t={})[0]="?",t[1]="!",t[2]="*",t[3]="/",t),F={"":!0,do:!0};e.Context=b,e.Renderer=h,e.escape=l,e.parse=function(e,r,t){void 0===r&&(r="{"),void 0===t&&(t="}");var n=function(e){for(var r,t,n,i,o,a,s=[],l=[],c=l,f=0,h=e.length;f<h;)switch(r=(a=e[f++])[0]){case 0:case 1:n=y(a),c.push(n),o=n,s.push(o),c=o[2]=[],o[3]=null;break;case 2:if(o=s.length?s[s.length-1]:void 0,t=a[1],!o||0!==o[0]||t!==o[1][0])throw new Error("Unexpected token '<type="+T[r]+", value="+t+">'");c=o[3]=[];break;case 3:if(o=s.pop(),t=a[1],!o||t!==o[1][0])throw new Error("Unexpected token '<type="+T[r]+", value="+t+">'");o[3]&&(o[0]=2),c=s.length?(i=(o=s[s.length-1])[3])?i:o[2]:l;break;case 5:case 6:n=y(a),c.push(n);break;default:c.push(a)}if(s.length)throw o=s.pop(),new Error("No matching section '<type="+T[o[0]]+", value="+o[1][0]+">'");return l}(o(e,r,t));return new h(n)},e.setFilterMap=function(e){p=e},e.tokenize=o,e.version="0.1.1",e.__esModule=!0});