(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e=e||self).IJ2TPL={})})(this,function(e){"use strict";function h(e,r){var t;4===e[0]&&(t=e[1],n.test(t)&&(t=t.replace(a,"")),t?e[1]=t:r.pop())}var r,t,v={},p=((r={})["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r),d=/[\s\xA0\uFEFF]+/g,n=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,a=/[\t \xA0\uFEFF]+$/;function g(e,r,t){for(var n,a,i,o=[7,""],s=[],l=0,c=e.length,f=r.length,u=t.length;l<c;){if(!~(i=e.indexOf(r,l))){(a=e.slice(l))&&(o=[4,a],s.push(o));break}if(a=e.slice(l,i),i+=f,a&&(o=[4,a],s.push(o)),!~(l=e.indexOf(t,i)))throw new Error("No matching prefix '"+r+"'");if("-"!==e[i]){if(a=e.slice(i,l),l+=u,a=a.replace(d,""))switch(n=a[0]){case"?":case"!":case"*":case"/":case"@":if(h(o,s),l<c)switch(e[l]){case"\n":l+=1;break;case"\r":l+=(i=l+1)<c&&"\n"===e[i]?2:1}case"#":o=[p[n],a.slice(1)],s.push(o);break;default:o=[6,a],s.push(o)}}else h(o,s),l+=u}return s}function w(e){return String(e).replace(i,function(e){return o[e]})}var b={}.hasOwnProperty,i=/["&'\/<=>`]/g,o={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},s=w,k=(l.prototype.resolve=function(e){var r,t,n,a,i,o,s=null,l=this,c=!1;if(!e[3])if(t=l.cache,n=e[0],b.call(t,n))s=t[n];else{(i=e[1])?(a=i[0],c=!0):a=n;do{if((r=l.data)&&b.call(r,a)){if(s=r[a],c)for(var f=1,u=i.length;f<u;f++){if(a=i[f],!s||!b.call(s,a)){s=null;break}s=s[a]}break}l=l.parent}while(l);"function"==typeof s&&(s=s(l)),t[n]=s}if(o=e[2])for(var h=0,p=o;h<p.length;h++){var d=p[h];if(!b.call(v,d))throw new Error("Cannot resolve filter '"+d+"'");s=v[d](s)}return s},l);function l(e,r){this.data=e,this.cache={".":this.data},this.parent=r}var c,y=Array.isArray;y||(c={}.toString,y=function(e){return"[object Array]"===c.call(e)});var f=(u.prototype.renderTree=function(e,r,t){for(var n,a,i="",o=!1,s=0,l=e;s<l.length;s++){var c=l[s];switch(c[0]){case 0:if(a=c,n=r.resolve(a[1]),(o=y(n))?n.length:n)if(o)for(var f=0,u=n;f<u.length;f++){var h=u[f];i+=this.renderTree(a[2],new k(h,r),t)}else i+=this.renderTree(a[2],new k(n,r),t);break;case 1:a=c,n=r.resolve(a[1]),((o=y(n))?n.length:n)||(i+=this.renderTree(a[2],r,t));break;case 2:if(a=c,n=r.resolve(a[1]),(o=y(n))?n.length:n)if(o)for(var p=0,d=n;p<d.length;p++)h=d[p],i+=this.renderTree(a[2],new k(h,r),t);else i+=this.renderTree(a[2],new k(n,r),t);else i+=this.renderTree(a[3],r,t);break;case 4:i+=n=c[1];break;case 5:null!=(n=r.resolve(c[1]))&&(i+=n);break;case 6:null!=(n=r.resolve(c[1]))&&(i+="number"==typeof n?n:w(n));break;case 8:if(n=c[1],!t||!b.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");i+=this.renderTree(t[n].treeRoot,r,t)}}return i},u.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new k(e,null),r)},u);function u(e){this.treeRoot=e}function x(e){var r=null,t=null,n=!1,a=e[1];return~a.indexOf("|")&&(a=(t=a.split("|"))[0],t=t.slice(1),T[a]&&(n=!0)),0<a.indexOf(".")&&(r=a.split(".")),[e[0],[a,r,t,n]]}var F=((t={})[0]="?",t[1]="!",t[2]="*",t[3]="/",t),T={"":!0,do:!0};Object.defineProperty||(Object.defineProperty=function(){}),e.Context=k,e.Renderer=f,e.escape=s,e.parse=function(u,h,p){void 0===h&&(h="{"),void 0===p&&(p="}");var e=function(){for(var e,r,t,n,a=[],i=[],o=i,s=0,l=g(u,h,p);s<l.length;s++){var c,f=l[s];switch(c=f[0]){case 0:case 1:r=x(f),o.push(r),n=r,a.push(n),o=n[2]=[],n[3]=null;break;case 2:if(n=a.length?a[a.length-1]:void 0,e=f[1],!n||0!==n[0]||e!==n[1][0])throw new Error("Unexpected token '<type="+F[c]+", value="+e+">'");o=n[3]=[];break;case 3:if(n=a.pop(),e=f[1],!n||e!==n[1][0])throw new Error("Unexpected token '<type="+F[c]+", value="+e+">'");n[3]&&(n[0]=2),o=a.length?(t=(n=a[a.length-1])[3])?t:n[2]:i;break;case 5:case 6:r=x(f),o.push(r);break;default:o.push(f)}}if(a.length)throw n=a.pop(),new Error("No matching section '<type="+F[n[0]]+", value="+n[1][0]+">'");return i}();return new f(e)},e.setFilterMap=function(e){v=e},e.tokenize=g,e.version="0.1.0",Object.defineProperty(e,"__esModule",{value:!0})});